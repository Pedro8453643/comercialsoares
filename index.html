<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Pedidos</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  /* Cores principais */
  --primary: #1a73e8;          
  --primary-dark: #155ab6;   
  --success: #22c55e;         
  --warning: #fbbf24;       
  --secondary: #F59E0B;   
  --error: #e84545;           
  --background: #f4f7fa;      
  --card-background: #fff;     
  --card-shadow: rgba(0,0,0,0.1); 
  --text-color: #333;          
  --text-light: #666; 
  --danger: #EF4444;         
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f8fafc;
  color: #334155;
  line-height: 1.6;
  font-size: 14px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 15px;
}

/* Tela de Login */
#login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--primary);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
  padding: 15px;
}

.login-container {
  background: white;
  padding: 1.5rem;
  border-radius: 10px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  width: 100%;
  max-width: 400px;
  text-align: center;
}

.login-container h2 {
  color: var(--primary);
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--border);
  font-size: 1.5rem;
}

.login-form .form-group {
  margin-bottom: 1.2rem;
  text-align: left;
}

.login-form label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.login-form input {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 1rem;
}

.login-form input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
}

.login-error {
  color: var(--danger);
  margin-top: 0.5rem;
  display: none;
  font-size: 0.9rem;
}

/* Header */
header {
  background: var(--primary);
  color: white;
  padding: 0.8rem 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  display: flex;
  flex-direction: column;
  align-items: center;
}

header h1 {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 0.8rem;
  text-align: center;
}

nav {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  justify-content: center;
  width: 100%;
}

.tab-btn {
  padding: 0.5rem 0.8rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  font-weight: 500;
  transition: all 0.3s ease;
  font-size: 0.85rem;
  flex: 1;
  min-width: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.3rem;
}

.tab-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

.tab-btn.active {
  background: white;
  color: var(--primary);
}

/* Main Content */
main {
  padding: 1.5rem 0;
}

.tab {
  display: none;
  background: white;
  border-radius: 10px;
  padding: 1.5rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  margin-top: 1rem;
}

.tab.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

h2 {
  color: var(--primary);
  margin-bottom: 1.2rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--border);
  font-size: 1.3rem;
}

/* Form Styles */
.form-group {
  margin-bottom: 1rem;
}

label {
  display: block;
  margin-bottom: 0.4rem;
  font-weight: 500;
  font-size: 0.95rem;
}

input, select, textarea {
  width: 100%;
  padding: 0.7rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 1rem;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
}

/* Button Styles */
.btn {
  padding: 0.7rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--secondary);
  color: white;
}

.btn-secondary:hover {
  background: #0da271;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-warning:hover {
  background: #d97706;
}

.btn-sm {
  padding: 0.4rem 0.8rem;
  font-size: 0.85rem;
}

/* Card Styles */
.card {
  background: white;
  border-radius: 8px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  border-left: 4px solid var(--primary);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.8rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.card-title {
  font-weight: 600;
  color: var(--primary);
  font-size: 1.1rem;
}

.card-actions {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
}

/* Grid System para mobile */
.row {
  display: flex;
  flex-wrap: wrap;
  margin: 0 -8px;
}

.col {
  flex: 1 0 100%;
  padding: 0 8px;
  margin-bottom: 15px;
}

/* Alert Styles */
.alert {
  padding: 0.9rem;
  border-radius: 6px;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-size: 0.95rem;
}

.alert-success {
  background: #ecfdf5;
  color: #065f46;
  border: 1px solid #a7f3d0;
}

.alert-error {
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

/* Badge */
.badge {
  display: inline-block;
  padding: 0.3rem 0.6rem;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 9999px;
}

.badge-success {
  background: #ecfdf5;
  color: #065f46;
}

.badge-warning {
  background: #fffbeb;
  color: #92400e;
}

/* Modal para mobile */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 15px;
}

.modal-content {
  background: white;
  padding: 1.5rem;
  border-radius: 10px;
  width: 100%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.2rem;
}

.modal-title {
  font-weight: 600;
  color: var(--primary);
  font-size: 1.2rem;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text);
}

/* Utilities */
.text-right {
  text-align: right;
}

.text-center {
  text-align: center;
}

.mt-1 {
  margin-top: 0.5rem;
}

.mt-2 {
  margin-top: 0.8rem;
}

.mt-3 {
  margin-top: 1.2rem;
}

.mb-1 {
  margin-bottom: 0.5rem;
}

.mb-2 {
  margin-bottom: 0.8rem;
}

.mb-3 {
  margin-bottom: 1.2rem;
}

.hidden {
  display: none;
}

/* Estilo para lista de pedidos em cards (alternativa à tabela) */
.pedido-card {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
  background: white;
}

.pedido-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.8rem;
  flex-wrap: wrap;
}

.pedido-card-title {
  font-weight: 600;
  color: var(--primary);
}

.pedido-card-body p {
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.pedido-card-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.8rem;
  flex-wrap: wrap;
}

/* Input group para formulários em mobile */
.input-group {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

/* Estilos para visualização de itens do pedido em mobile */
.item-list {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  margin: 1rem 0;
}

.item-card {
  background: #f8fafc;
  border-radius: 8px;
  padding: 1rem;
  border-left: 4px solid var(--primary);
}

.item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
  flex-wrap: wrap;
}

.item-name {
  font-weight: 600;
  color: var(--primary);
  margin-right: 1rem;
}

.item-details {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.item-detail {
  display: flex;
  flex-direction: column;
  min-width: 100px;
}

.detail-label {
  font-size: 0.8rem;
  color: #64748b;
  margin-bottom: 0.2rem;
}

.detail-value {
  font-weight: 600;
}

.item-total {
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px dashed var(--border);
  font-weight: 600;
  display: flex;
  justify-content: space-between;
}

.summary-card {
  background: white;
  border-radius: 8px;
  padding: 1rem;
  margin: 1rem 0;
  border: 1px solid var(--border);
}

.summary-row {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
}

.summary-row:last-child {
  border-bottom: none;
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--primary);
}

/* Estilo para a seção de colar produtos */
.collapsible-section {
  margin-top: 1rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  overflow: hidden;
}

.collapsible-header {
  background-color: #f8f9fa;
  padding: 0.7rem;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 500;
}

.collapsible-content {
  padding: 0;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}

.collapsible-content.expanded {
  padding: 1rem;
  max-height: 300px;
}

.paste-instructions {
  background-color: #f1f8ff;
  padding: 0.8rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  font-size: 0.9rem;
}

.paste-example {
  font-family: monospace;
  background-color: #f6f8fa;
  padding: 0.5rem;
  border-radius: 4px;
  margin-top: 0.5rem;
}

@media (min-width: 576px) {
  .input-group {
    flex-direction: row;
  }
  
  .input-group .form-group {
    flex: 1;
  }
  
  .header-content {
    flex-direction: row;
    justify-content: space-between;
  }
  
  header h1 {
    margin-bottom: 0;
    text-align: left;
  }
  
  nav {
    width: auto;
    flex-wrap: nowrap;
  }
  
  .tab-btn {
    min-width: auto;
  }
  
  .col {
    flex: 1;
    min-width: auto;
  }
}

/* Melhorias para formulários em mobile */
.form-control {
  width: 100%;
  padding: 0.8rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 1rem;
}

/* Ajustes para inputs numéricos em mobile */
input[type="number"] {
  -webkit-appearance: none;
  -moz-appearance: textfield;
}

/* Remove setas em inputs number */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
</style>
</head>
<body>
<!-- Tela de Login -->
<div id="login-screen">
  <div class="login-container">
    <h2><i class="fas fa-lock"></i> Acesso Restrito</h2>
    <form class="login-form" onsubmit="return fazerLogin(event)">
      <div class="form-group">
        <label for="codigoAcesso">Código de Acesso</label>
        <input type="password" id="codigoAcesso" placeholder="Digite o código de acesso" required>
        <div class="login-error" id="loginError">
          <i class="fas fa-exclamation-circle"></i> Código de acesso incorreto
        </div>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
    </form>
  </div>
</div>

<!-- Conteúdo Principal (inicialmente oculto) -->
<div id="main-content" style="display: none;">
  <header>
    <div class="container">
      <div class="header-content">
        <h1><i class="fas fa-store"></i> Comercial Soares</h1>
        <nav>
          <button class="tab-btn active" data-tab="criar"><i class="fas fa-plus-circle"></i> Criar</button>
          <button class="tab-btn" data-tab="ver"><i class="fas fa-list"></i> Ver</button>
          <button class="tab-btn" data-tab="reabrir"><i class="fas fa-undo"></i> Reabrir</button>
          <button class="tab-btn" onclick="sair()"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Criar Pedido -->
    <div id="criar" class="tab active">
      <h2><i class="fas fa-plus-circle"></i> Criar Pedido</h2>
      
      <div class="form-group">
        <label for="clienteNome">Nome do Cliente</label>
        <input type="text" id="clienteNome" placeholder="Digite o nome do cliente">
      </div>
      
      <button class="btn btn-primary" onclick="iniciarPedido()">
        <i class="fas fa-play"></i> Iniciar Pedido
      </button>

      <div id="pedidoSection" class="hidden mt-3">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" id="pedidoCliente"></h3>
            <span class="badge badge-warning">Em Andamento</span>
          </div>
          
          <div class="item-list" id="itensPedidoMobile">
            <div class="text-center">Nenhum item adicionado ainda</div>
          </div>
          
          <div class="summary-card">
            <div class="summary-row">
              <span>Total Geral:</span>
              <span id="totalGeralMobile">R$ 0,00</span>
            </div>
          </div>
          
          <div class="mt-3">
            <h3><i class="fas fa-plus"></i> Adicionar Item</h3>
            <div class="input-group">
              <div class="form-group">
                <label for="produto">Produto</label>
                <input type="text" id="produto" placeholder="Nome do produto">
              </div>
              <div class="form-group">
                <label for="quantidade">Quantidade</label>
                <input type="number" id="quantidade" placeholder="0" min="1">
              </div>
            </div>
            <div class="form-group">
              <label for="preco">Preço Unitário (R$)</label>
              <input type="number" id="preco" placeholder="0" step="0.01" min="0">
            </div>
            
            <!-- Seção para colar produtos -->
            <div class="collapsible-section">
              <div class="collapsible-header" onclick="toggleCollapsible('pasteSection')">
                <span><i class="fas fa-paste"></i> Colar Produtos</span>
                <span id="pasteSectionIcon"><i class="fas fa-chevron-down"></i></span>
              </div>
              <div id="pasteSection" class="collapsible-content">
                <div class="paste-instructions">
                  <p>Cole abaixo os produtos no formato: <strong>Quantidade Nome vPreço</strong></p>
                </div>
                <div class="form-group">
                  <textarea id="produtosParaColar" rows="5" placeholder="Cole aqui os produtos"></textarea>
                </div>
              </div>
            </div>
            
            <button class="btn btn-primary mt-2" id="btnAdicionarItem" onclick="adicionarItem()">
              <i class="fas fa-plus"></i> Adicionar Item
            </button>
          </div>
          
          <div class="mt-3 text-right"> 
            <button class="btn btn-secondary" onclick="finalizarPedido()">
              <i class="fas fa-check"></i> Finalizar Pedido
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ver Pedidos -->
    <div id="ver" class="tab">
      <h2><i class="fas fa-list"></i> Pedidos Finalizados</h2>
      <div id="listaPedidos" class="mt-2">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> Carregando pedidos...
        </div>
      </div>
    </div>

    <!-- Reabrir Pedidos -->
    <div id="reabrir" class="tab">
      <h2><i class="fas fa-undo"></i> Reabrir Pedidos</h2>
      
      <div class="form-group">
        <label for="selectPedido">Selecione um pedido para reabrir</label>
        <select id="selectPedido" onchange="abrirPedidoReaberto()">
          <option value="">Selecione um pedido</option>
        </select>
      </div>
      
      <div id="detalhesReaberto" class="mt-3"></div>
    </div>
  </main>

  <!-- Modal para visualizar pedido -->
  <div id="modalPedido" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Detalhes do Pedido</h3>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
// Inicializar jsPDF
const { jsPDF } = window.jspdf;

// Variáveis globales
let pedidos = JSON.parse(localStorage.getItem('pedidos') || '{}');
let pedidoAtivo = null;
const SENHA_CORRETA = "S600ad"; // Senha definida

// Verificar se o usuário já está logado
document.addEventListener('DOMContentLoaded', function() {
  const estaLogado = localStorage.getItem('logado') === 'true';
  
  if (estaLogado) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    inicializarSistema();
  }
});

// Função para fazer login
function fazerLogin(event) {
  event.preventDefault();
  const codigo = document.getElementById('codigoAcesso').value;
  const erroLogin = document.getElementById('loginError');
  
  if (codigo === SENHA_CORRETA) {
    // Login bem-sucedido
    localStorage.setItem('logado', 'true');
    document.getElementById('login-screen').style.opacity = '0';
    
    setTimeout(() => {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      inicializarSistema();
    }, 500);
  } else {
    // Login falhou
    erroLogin.style.display = 'block';
    setTimeout(() => {
      erroLogin.style.display = 'none';
    }, 3000);
  }
}

// Função para sair do sistema
function sair() {
  localStorage.removeItem('logado');
  document.getElementById('main-content').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('login-screen').style.opacity = '1';
  document.getElementById('codigoAcesso').value = '';
}

// Inicializar o sistema após login
function inicializarSistema() {
  atualizarListaPedidos();
  atualizarSelectPedido();
  
  // Configurar abas
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (!btn.onclick) { // Evitar duplicar eventos
      btn.addEventListener('click', () => {
        if (btn.dataset.tab) {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          
          document.getElementById(btn.dataset.tab).classList.add('active');
          btn.classList.add('active');
          
          // Atualizar as listas quando mudar para as abas correspondentes
          if (btn.dataset.tab === 'ver') {
            atualizarListaPedidos();
          } else if (btn.dataset.tab === 'reabrir') {
            atualizarSelectPedido();
          }
        }
      });
    }
  });
}

// Função para salvar no localStorage
function salvar() {
  localStorage.setItem('pedidos', JSON.stringify(pedidos));
  atualizarListaPedidos();
  atualizarSelectPedido();
}

// Função para mostrar notificação
function mostrarNotificacao(mensagem, tipo = 'success') {
  const notification = document.createElement('div');
  notification.className = `alert alert-${tipo === 'success' ? 'success' : 'error'}`;
  notification.innerHTML = `
    <i class="fas ${tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
    ${mensagem}
  `;
  
  document.querySelector('main').prepend(notification);
  
  // Remover após 3 segundos
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Função para iniciar um novo pedido
function iniciarPedido() {
  const nome = document.getElementById('clienteNome').value.trim();
  if (!nome) {
    mostrarNotificacao('Digite o nome do cliente', 'error');
    return;
  }
  
  const pid = Date.now().toString();
  pedidos[pid] = { 
    cliente: nome, 
    itens: [], 
    finalizado: false,
    numero: Object.keys(pedidos).length + 1,
    data: new Date().toLocaleString('pt-BR')
  };
  
  pedidoAtivo = pid;
  document.getElementById('pedidoCliente').innerText = `Pedido de: ${nome}`;
  document.getElementById('pedidoSection').classList.remove('hidden');
  document.getElementById('clienteNome').value = '';
  
  atualizarItens();
  salvar();
  mostrarNotificacao('Pedido iniciado com sucesso!');
}

// Função para atualizar a lista de itens do pedido
function atualizarItens() {
  const container = document.getElementById('itensPedidoMobile');
  const pedido = pedidos[pedidoAtivo];
  
  if (pedido.itens.length === 0) {
    container.innerHTML = '<div class="text-center">Nenhum item adicionado ainda</div>';
    document.getElementById('totalGeralMobile').innerText = 'R$ 0,00';
    return;
  }
  
  container.innerHTML = '';
  let totalGeral = 0;
  
  pedido.itens.forEach((item, idx) => {
    const totalItem = item.quantidade * item.preco;
    totalGeral += totalItem;
    
    container.innerHTML += `
      <div class="item-card">
        <div class="item-header">
          <span class="item-name">${item.produto}</span>
          <button class="btn btn-danger btn-sm" onclick="removerItem(${idx})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="item-details">
          <div class="item-detail">
            <span class="detail-label">Quantidade</span>
            <span class="detail-value">${item.quantidade}</span>
          </div>
          <div class="item-detail">
            <span class="detail-label">Preço Unit.</span>
            <span class="detail-value">R$ ${item.preco.toFixed(2)}</span>
          </div>
        </div>
        <div class="item-total">
          <span>Total do Item:</span>
          <span>R$ ${totalItem.toFixed(2)}</span>
        </div>
      </div>
    `;
  });
  
  document.getElementById('totalGeralMobile').innerText = `R$ ${totalGeral.toFixed(2)}`;
}

// Função para adicionar item ao pedido
function adicionarItem() {
  if (!pedidoAtivo) {
    mostrarNotificacao('Inicie um pedido primeiro', 'error');
    return;
  }
  
  const pasteSection = document.getElementById('pasteSection');
  
  // Verificar se a seção de colar está expandida
  if (pasteSection.classList.contains('expanded')) {
    // Se estiver expandida, processar os produtos colados
    processarProdutosColados();
    return;
  }
  
  // Se não estiver expandida, adicionar item individual
  const produto = document.getElementById('produto').value.trim();
  const quantidadeInput = document.getElementById('quantidade').value;
  const precoInput = document.getElementById('preco').value;
  
  // Verificar se os campos estão vazios
  if (!produto || !quantidadeInput || !precoInput) {
    mostrarNotificacao('Preencha todos os campos', 'error');
    return;
  }
  
  const quantidade = parseInt(quantidadeInput);
  const preco = parseFloat(precoInput);
  
  if (quantidade <= 0 || preco < 0) {
    mostrarNotificacao('Valores devem ser positivos', 'error');
    return;
  }
  
  pedidos[pedidoAtivo].itens.push({ produto, quantidade, preco });
  
  // Limpar os campos, mas manter o placeholder
  document.getElementById('produto').value = '';
  document.getElementById('quantidade').value = '';
  document.getElementById('preco').value = '';
  
  atualizarItens();
  salvar();
  mostrarNotificacao('Item adicionado com sucesso!');
}

// Função para remover item do pedido
function removerItem(idx) {
  pedidos[pedidoAtivo].itens.splice(idx, 1);
  atualizarItens();
  salvar();
  mostrarNotificacao('Item removido com sucesso!');
}

// Função para finalizar o pedido
function finalizarPedido() {
  if (pedidos[pedidoAtivo].itens.length === 0) {
    mostrarNotificacao('Não é possível finalizar pedido vazio', 'error');
    return;
  }
  
  pedidos[pedidoAtivo].finalizado = true;
  gerarPDF(pedidos[pedidoAtivo]);
  
  mostrarNotificacao('Pedido finalizado com sucesso! PDF gerado.');
  
  pedidoAtivo = null;
  document.getElementById('pedidoSection').classList.add('hidden');
  salvar();
}

// Função para atualizar a lista de pedidos na aba "Ver Pedidos"
function atualizarListaPedidos() {
  const container = document.getElementById('listaPedidos');
  const pedidosFinalizados = Object.entries(pedidos)
    .filter(([_, pedido]) => pedido.finalizado)
    .sort((a, b) => b[1].numero - a[1].numero);
  
  if (pedidosFinalizados.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Nenhum pedido finalizado ainda.
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  
  pedidosFinalizados.forEach(([pid, pedido]) => {
    let totalGeral = 0;
    pedido.itens.forEach(item => {
      totalGeral += item.quantidade * item.preco;
    });
    
    const card = document.createElement('div');
    card.className = 'pedido-card';
    card.innerHTML = `
      <div class="pedido-card-header">
        <h3 class="pedido-card-title">Pedido #${pedido.numero} - ${pedido.cliente}</h3>
        <span class="badge badge-success">Finalizado</span>
      </div>
      <div class="pedido-card-body">
        <p><strong>Data:</strong> ${pedido.data}</p>
        <p><strong>Total:</strong> R$ ${totalGeral.toFixed(2)}</p>
        <p><strong>Itens:</strong> ${pedido.itens.length}</p>
      </div>
      <div class="pedido-card-actions">
        <button class="btn btn-primary btn-sm" onclick="visualizarPedido('${pid}')">
          <i class="fas fa-eye"></i> Visualizar
        </button>
        <button class="btn btn-secondary btn-sm" onclick="baixarPDF('${pid}')">
          <i class="fas fa-download"></i> Baixar PDF
        </button>
        <button class="btn btn-danger btn-sm" onclick="excluirPedido('${pid}')">
          <i class="fas fa-trash"></i> Excluir
        </button>
      </div>
    `;
    
    container.appendChild(card);
  });
}

// Função para excluir um pedido
function excluirPedido(pid) {
  if (confirm('Tem certeza que deseja excluir este pedido? Esta ação não pode ser desfeita.')) {
    delete pedidos[pid];
    salvar();
    atualizarListaPedidos();
    mostrarNotificacao('Pedido excluído com sucesso!');
  }
}

// Função para visualizar detalhes do pedido (MOBILE-FRIENDLY)
function visualizarPedido(pid) {
  const pedido = pedidos[pid];
  let totalGeral = 0;
  
  let html = `
    <div class="mb-2">
      <div class="detail-label">Data do Pedido</div>
      <div class="detail-value">${pedido.data}</div>
    </div>
    <div class="mb-2">
      <div class="detail-label">Cliente</div>
      <div class="detail-value">${pedido.cliente}</div>
    </div>
    
    <h4 class="mt-3 mb-2">Itens do Pedido</h4>
    <div class="item-list">
  `;
  
  pedido.itens.forEach((item, idx) => {
    const totalItem = item.quantidade * item.preco;
    totalGeral += totalItem;
    
    html += `
      <div class="item-card">
        <div class="item-header">
          <span class="item-name">${item.produto}</span>
        </div>
        <div class="item-details">
          <div class="item-detail">
            <span class="detail-label">Quantidade</span>
            <span class="detail-value">${item.quantidade}</span>
          </div>
          <div class="item-detail">
            <span class="detail-label">Preço Unit.</span>
            <span class="detail-value">R$ ${item.preco.toFixed(2)}</span>
          </div>
        </div>
        <div class="item-total">
          <span>Total do Item:</span>
          <span>R$ ${totalItem.toFixed(2)}</span>
        </div>
      </div>
    `;
  });
  
  html += `
    </div>
    
    <div class="summary-card mt-2">
      <div class="summary-row">
        <span>Total Geral:</span>
        <span>R$ ${totalGeral.toFixed(2)}</span>
      </div>
    </div>
    
    <div class="text-right mt-2">
      <button class="btn btn-secondary" onclick="baixarPDF('${pid}')">
        <i class="fas fa-download"></i> Baixar PDF
      </button>
      <button class="btn btn-danger" onclick="excluirPedido('${pid}')">
        <i class="fas fa-trash"></i> Excluir Pedido
      </button>
    </div>
  `;
  
  document.getElementById('modalTitle').innerText = `Pedido #${pedido.numero}`;
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalPedido').style.display = 'flex';
}

// Função para fechar o modal
function fecharModal() {
  document.getElementById('modalPedido').style.display = 'none';
}

// Função para atualizar o select de pedidos na aba "Reabrir Pedidos"
function atualizarSelectPedido() {
  const select = document.getElementById('selectPedido');
  const pedidosFinalizados = Object.entries(pedidos)
    .filter(([_, pedido]) => pedido.finalizado)
    .sort((a, b) => b[1].numero - a[1].numero);
  
  select.innerHTML = '<option value="">Selecione um pedido</option>';
  
  pedidosFinalizados.forEach(([pid, pedido]) => {
    select.innerHTML += `<option value="${pid}">Pedido #${pedido.numero} - ${pedido.cliente}</option>`;
  });
  
  document.getElementById('detalhesReaberto').innerHTML = '';
}

// Função para abrir pedido reaberto
function abrirPedidoReaberto() {
  const pid = document.getElementById('selectPedido').value;
  if (!pid) return;
  
  // Marcar o pedido como não finalizado
  pedidos[pid].finalizado = false;
  pedidoAtivo = pid;
  
  // Mudar para a aba de Criar Pedido
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  
  document.getElementById('criar').classList.add('active');
  document.querySelector('[data-tab="criar"]').classList.add('active');
  
  // Preencher os dados do pedido reaberto na aba de criação
  document.getElementById('pedidoCliente').innerText = `Pedido de: ${pedidos[pid].cliente}`;
  document.getElementById('pedidoSection').classList.remove('hidden');
  
  atualizarItens();
  salvar();
  mostrarNotificacao('Pedido reaberto com sucesso!');
}

// Função para gerar PDF idêntico ao modelo enviado, com quebra de página e borda em todas as páginas
function gerarPDF(pedido, download = false) {
  const doc = new jsPDF();

  // Função auxiliar: desenhar borda
  function desenharBorda() {
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.rect(10, 10, 190, 277);
  }

  // Função auxiliar: cabeçalho da tabela
  function desenharCabecalhoTabela(y) {
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.rect(10, y, 40, 10);
    doc.text("Quantidade", 30, y + 7, { align: "center" });
    doc.rect(50, y, 90, 10);
    doc.text("Produto", 95, y + 7, { align: "center" });
    doc.rect(140, y, 30, 10);
    doc.text("Preço Unitário", 155, y + 7, { align: "center" });
    doc.rect(170, y, 30, 10);
    doc.text("Total", 185, y + 7, { align: "center" });
  }

  // ===== PRIMEIRA PÁGINA =====
  desenharBorda();

  // Título
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text("PEDIDO ELETRÔNICO", 105, 20, { align: "center" });

  let y = 30;

  // ===== DADOS DA EMPRESA =====
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.setFillColor(230, 230, 230);
  doc.rect(11, y, 188, 8, "F");
  doc.text("DADOS DA EMPRESA", 105, y + 6, { align: "center" });

  y += 12;
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.rect(10, y, 95, 10);
  doc.text("Comercial Soares", 12, y + 7);
  doc.rect(105, y, 95, 10);
  doc.text("CNPJ: 40.457.273/0001-84", 107, y + 7);

  y += 10;
  doc.rect(10, y, 95, 10);
  doc.text("Telefone: 34 99985-8000", 12, y + 7);
  doc.rect(105, y, 95, 10);
  doc.text("Rua: Getúlio Vargas, Nº 631", 107, y + 7);

  // ===== DADOS DO PEDIDO =====
  y += 15;
  doc.setFont(undefined, 'bold');
  doc.setFillColor(230, 230, 230);
  doc.rect(11, y, 188, 8, "F");
  doc.text("DADOS DO PEDIDO", 105, y + 6, { align: "center" });

  y += 12;
  doc.setFont(undefined, 'normal');
  doc.rect(10, y, 95, 10);
  doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 12, y + 7);
  doc.rect(105, y, 95, 10);
  doc.text(`Pedido Nº: ${pedido.numero}`, 107, y + 7);

  y += 10;
  doc.rect(10, y, 190, 10);
  doc.text(`Cliente: ${pedido.cliente}`, 12, y + 7);

  // ===== PRODUTOS =====
  y += 15;
  doc.setFont(undefined, 'bold');
  doc.setFillColor(230, 230, 230);
  doc.rect(11, y, 188, 8, "F");
  doc.text("PRODUTOS", 105, y + 6, { align: "center" });

  // Cabeçalho da tabela
  y += 10;
  desenharCabecalhoTabela(y);

  // Itens do pedido
  y += 10;
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  let totalGeral = 0;

  const alturaMax = 250; // limite antes de quebrar
  pedido.itens.forEach(item => {
    const totalItem = item.quantidade * item.preco;
    totalGeral += totalItem;

    // Se passar do limite, cria nova página
    if (y > alturaMax) {
      doc.addPage();
      desenharBorda(); // redesenha a borda
      y = 20; // espaço inicial na nova página

      // Apenas redesenha a tabela
      desenharCabecalhoTabela(y);
      y += 10;
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
    }

    // Linha do item
    doc.rect(10, y, 40, 10);
    doc.text(String(item.quantidade), 30, y + 7, { align: "center" });

    doc.rect(50, y, 90, 10);
    let nome = item.produto.length > 35 ? item.produto.substring(0, 32) + "..." : item.produto;
    doc.text(nome, 52, y + 7);

    doc.rect(140, y, 30, 10);
    doc.text(`R$ ${item.preco.toFixed(2)}`, 155, y + 7, { align: "center" });

    doc.rect(170, y, 30, 10);
    doc.text(`R$ ${totalItem.toFixed(2)}`, 185, y + 7, { align: "center" });

    y += 10;
  });

  // TOTAL GERAL
  if (y > alturaMax) {
    doc.addPage();
    desenharBorda();
    y = 20;
    desenharCabecalhoTabela(y);
    y += 10;
  }
  doc.setFont(undefined, 'bold');
  doc.rect(10, y, 160, 10);
  doc.text("TOTAL GERAL", 90, y + 7, { align: "center" });
  doc.rect(170, y, 30, 10);
  doc.text(`R$ ${totalGeral.toFixed(2)}`, 185, y + 7, { align: "center" });

  // ===== ASSINATURA =====
  y += 20;
  if (y > alturaMax) {
    doc.addPage();
    desenharBorda();
    y = 20;
  }
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.setFillColor(230, 230, 230);
  doc.rect(11, y, 188, 8, "F");
  doc.text("ASSINATURA", 105, y + 6, { align: "center" });

  y += 12;
  doc.rect(10, y, 190, 30);
  doc.setFont(undefined, 'normal');
  doc.text("Ass: ___________________________________", 12, y + 20);

  // Baixar ou retornar
  if (download) {
    doc.save(`pedido_${pedido.numero}.pdf`);
  }
  return doc;
}

// Função para baixar PDF
function baixarPDF(pid) {
  gerarPDF(pedidos[pid], true);
  mostrarNotificacao('PDF baixado com sucesso!');
}

// Função para expandir/recolher a seção de colar produtos
function toggleCollapsible(sectionId) {
  const content = document.getElementById(sectionId);
  const icon = document.getElementById(sectionId + 'Icon');
  const btnAdicionar = document.getElementById('btnAdicionarItem');
  
  content.classList.toggle('expanded');
  
  if (content.classList.contains('expanded')) {
    icon.innerHTML = '<i class="fas fa-chevron-up"></i>';
    btnAdicionar.innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Produtos';
  } else {
    icon.innerHTML = '<i class="fas fa-chevron-down"></i>';
    btnAdicionar.innerHTML = '<i class="fas fa-plus"></i> Adicionar Item';
  }
}

// Função para processar produtos colados - VERSÃO CORRIGIDA
function processarProdutosColados() {
  if (!pedidoAtivo) {
    mostrarNotificacao('Inicie um pedido primeiro', 'error');
    return;
  }
  
  const texto = document.getElementById('produtosParaColar').value.trim();
  if (!texto) {
    mostrarNotificacao('Cole os produtos no formato correto', 'error');
    return;
  }
  
  // Dividir o texto em partes usando espaços como separadores
  const partes = texto.split(/\s+/);
  let produtosAdicionados = 0;
  let erros = 0;
  let i = 0;
  
  while (i < partes.length) {
    // Verificar se há pelo menos 3 partes (quantidade, nome e preço)
    if (i + 2 >= partes.length) {
      erros++;
      break;
    }
    
    // A primeira parte deve ser a quantidade
    const quantidade = parseInt(partes[i]);
    if (isNaN(quantidade) || quantidade <= 0) {
      erros++;
      i++;
      continue;
    }
    
    // Procurar pela próxima parte que começa com "v" (que será o preço)
    let j = i + 1;
    let precoIndex = -1;
    
    while (j < partes.length) {
      if (partes[j].startsWith('v') && !isNaN(parseFloat(partes[j].substring(1).replace(',', '.')))) {
        precoIndex = j;
        break;
      }
      j++;
    }
    
    if (precoIndex === -1) {
      erros++;
      break;
    }
    
    // A parte no índice precoIndex deve ser o preço
    const preco = parseFloat(partes[precoIndex].substring(1).replace(',', '.'));
    if (isNaN(preco) || preco < 0) {
      erros++;
      i = precoIndex + 1;
      continue;
    }
    
    // Tudo entre i+1 e precoIndex-1 é o nome do produto
    const nomeParts = [];
    for (let k = i + 1; k < precoIndex; k++) {
      nomeParts.push(partes[k]);
    }
    
    const produto = nomeParts.join(' ');
    
    if (produto && quantidade > 0 && preco >= 0) {
      pedidos[pedidoAtivo].itens.push({ 
        produto, 
        quantidade, 
        preco 
      });
      produtosAdicionados++;
      
      // Avançar para o próximo produto (após o preço)
      i = precoIndex + 1;
    } else {
      erros++;
      i++;
    }
  }
  
  if (produtosAdicionados > 0) {
    atualizarItens();
    salvar();
    document.getElementById('produtosParaColar').value = '';
    mostrarNotificacao(`${produtosAdicionados} produto(s) adicionado(s) com sucesso!${erros > 0 ? ` ${erros} erro(s) encontrado(s).` : ''}`);
    
    // Recolher a seção de colar após processar
    toggleCollapsible('pasteSection');
  } else if (erros > 0) {
    mostrarNotificacao('Nenhum produto válido encontrado. Verifique o formato.', 'error');
  }
}
</script>
</body>
</html>
